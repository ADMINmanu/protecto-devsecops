name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:

  #########################################
  #              SAST - SEMGREP
  #########################################
  sast_semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar Semgrep
        run: pip install semgrep

      - name: Ejecutar SAST (Semgrep)
        run: semgrep --config "p/owasp-top-ten" . --error --json > semgrep_report.json

      - name: Guardar reporte SAST
        uses: actions/upload-artifact@v4
        with:
          name: semgrep_report
          path: semgrep_report.json

      - name: Procesar reporte SAST
        run: |
          HIGH=$(jq '[.results[] | select(.extra.severity=="ERROR")] | length' semgrep_report.json)
          MED=$(jq '[.results[] | select(.extra.severity=="WARNING")] | length' semgrep_report.json)
          LOW=$(jq '[.results[] | select(.extra.severity=="INFO")] | length' semgrep_report.json)

          TOTAL=$((HIGH + MED + LOW))

          echo "SAST_HIGH=$HIGH" >> $GITHUB_ENV
          echo "SAST_MED=$MED" >> $GITHUB_ENV
          echo "SAST_LOW=$LOW" >> $GITHUB_ENV
          echo "SAST_TOTAL=$TOTAL" >> $GITHUB_ENV


  #########################################
  #              SCA - TRIVY
  #########################################
  sca_trivy:
    name: SCA - Trivy
    runs-on: ubuntu-latest
    needs: sast_semgrep
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install trivy -y

      - name: Ejecutar SCA en sistema (NO detiene pipeline)
        run: trivy fs . --severity HIGH,CRITICAL --exit-code 0 --format json -o trivy_report.json

      - name: Guardar reporte SCA
        uses: actions/upload-artifact@v4
        with:
          name: trivy_report
          path: trivy_report.json

      - name: Procesar reporte SCA
        run: |
          CRIT=$(jq '[.Results[].Vulnerabilities // [] | .[] | select(.Severity=="CRITICAL")] | length' trivy_report.json)
          HIGH=$(jq '[.Results[].Vulnerabilities // [] | .[] | select(.Severity=="HIGH")] | length' trivy_report.json)
          MED=$(jq '[.Results[].Vulnerabilities // [] | .[] | select(.Severity=="MEDIUM")] | length' trivy_report.json)
          LOW=$(jq '[.Results[].Vulnerabilities // [] | .[] | select(.Severity=="LOW")] | length' trivy_report.json)
          INFO=$(jq '[.Results[].Vulnerabilities // [] | .[] | select(.Severity=="UNKNOWN" or .Severity=="INFO")] | length' trivy_report.json)

          TOTAL=$((CRIT + HIGH + MED + LOW + INFO))

          echo "SCA_CRIT=$CRIT" >> $GITHUB_ENV
          echo "SCA_HIGH=$HIGH" >> $GITHUB_ENV
          echo "SCA_MED=$MED" >> $GITHUB_ENV
          echo "SCA_LOW=$LOW" >> $GITHUB_ENV
          echo "SCA_INFO=$INFO" >> $GITHUB_ENV
          echo "SCA_TOTAL=$TOTAL" >> $GITHUB_ENV


  #########################################
  #              DAST - OWASP ZAP
  #########################################
  dast_zap:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: sca_trivy
    steps:
      - name: Ejecutar ZAP Baseline Scan
        run: |
          docker run --rm \
            -v /tmp/:/zap/wrk/:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t https://demo.testfire.net/ -r zap_report.html

      - name: Guardar reporte ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap_report
          path: /tmp/zap_report.html

      - name: Procesar reporte DAST
        run: |
          HIGH=$(grep -ci "High" zap_report.html || true)
          MED=$(grep -ci "Medium" zap_report.html || true)
          LOW=$(grep -ci "Low" zap_report.html || true)
          INFO=$(grep -ci "Informational" zap_report.html || true)

          TOTAL=$((HIGH + MED + LOW + INFO))

          echo "DAST_HIGH=$HIGH" >> $GITHUB_ENV
          echo "DAST_MED=$MED" >> $GITHUB_ENV
          echo "DAST_LOW=$LOW" >> $GITHUB_ENV
          echo "DAST_INFO=$INFO" >> $GITHUB_ENV
          echo "DAST_TOTAL=$TOTAL" >> $GITHUB_ENV


  #########################################
  #       RESUMEN FINAL DE VULNERABILIDADES
  #########################################
  resumen_final:
    name: Resumen de Vulnerabilidades
    runs-on: ubuntu-latest
    needs: [sast_semgrep, sca_trivy, dast_zap]
    if: always()
    steps:
      - name: Generar resumen en consola
        run: |
          echo "===== RESUMEN FINAL ====="
          echo ""
          echo "---- SAST ----"
          echo "HIGH: $SAST_HIGH"
          echo "MEDIUM: $SAST_MED"
          echo "LOW: $SAST_LOW"
          echo "TOTAL SAST: $SAST_TOTAL"
          echo ""
          echo "---- SCA ----"
          echo "CRITICAL: $SCA_CRIT"
          echo "HIGH: $SCA_HIGH"
          echo "MEDIUM: $SCA_MED"
          echo "LOW: $SCA_LOW"
          echo "INFO: $SCA_INFO"
          echo "TOTAL SCA: $SCA_TOTAL"
          echo ""
          echo "---- DAST ----"
          echo "HIGH: $DAST_HIGH"
          echo "MEDIUM: $DAST_MED"
          echo "LOW: $DAST_LOW"
          echo "INFO: $DAST_INFO"
          echo "TOTAL DAST: $DAST_TOTAL"
          echo ""
          echo "=========================="

      - name: Fallar si hay vulnerabilidades críticas o altas
        run: |
          TOTAL_HIGH=$((SAST_HIGH + SCA_CRIT + SCA_HIGH + DAST_HIGH))
          if [ "$TOTAL_HIGH" -gt 0 ]; then
            echo "❌ Se detectaron vulnerabilidades CRÍTICAS o ALTAS."
            exit 1
          else
            echo "✅ No se detectaron vulnerabilidades críticas o altas."
          fi
