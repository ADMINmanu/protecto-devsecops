name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:

  # -------------------------
  # SAST - SEMGREP
  # -------------------------
  sast_semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    outputs:
      sast_summary: ${{ steps.parse.outputs.summary }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: Instalar Semgrep
        run: pip install semgrep jq

      - name: Ejecutar SAST (Semgrep)
        run: semgrep --config "p/owasp-top-ten" . --json > semgrep_report.json

      - name: Procesar reporte SAST
        id: parse
        run: |
          CRIT=$(jq '[.results[] | select(.extra.severity=="CRITICAL")] | length' semgrep_report.json)
          HIGH=$(jq '[.results[] | select(.extra.severity=="HIGH")] | length' semgrep_report.json)
          MED=$(jq '[.results[] | select(.extra.severity=="MEDIUM")] | length' semgrep_report.json)
          LOW=$(jq '[.results[] | select(.extra.severity=="LOW")] | length' semgrep_report.json)
          INFO=$(jq '[.results[] | select(.extra.severity=="INFO")] | length' semgrep_report.json)
          TOTAL=$((CRIT + HIGH + MED + LOW + INFO))

          SUMMARY="CRITICAL:$CRIT,HIGH:$HIGH,MEDIUM:$MED,LOW:$LOW,INFO:$INFO,TOTAL:$TOTAL"
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

          echo "$SUMMARY" > sast_summary.txt

      - name: Guardar reporte SAST
        uses: actions/upload-artifact@v4
        with:
          name: semgrep_report
          path: |
            semgrep_report.json
            sast_summary.txt


  # -------------------------
  # SCA - TRIVY
  # -------------------------
  sca_trivy:
    name: SCA - Trivy
    runs-on: ubuntu-latest
    needs: sast_semgrep
    outputs:
      sca_summary: ${{ steps.parse.outputs.summary }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: Instalar Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install wget apt-transport-https gnupg jq lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install trivy -y

      - name: Ejecutar SCA
        run: trivy fs . --format json -o trivy_report.json --severity CRITICAL,HIGH,MEDIUM,LOW


      - name: Procesar reporte SCA
        id: parse_sca
        run: |
          CRIT=$(jq '[.Results // [] | map(.Vulnerabilities // []) | add | map(select(.Severity=="CRITICAL"))] | length' trivy_report.json)
          HIGH=$(jq '[.Results // [] | map(.Vulnerabilities // []) | add | map(select(.Severity=="HIGH"))] | length' trivy_report.json)
          MED=$(jq '[.Results // [] | map(.Vulnerabilities // []) | add | map(select(.Severity=="MEDIUM"))] | length' trivy_report.json)
          LOW=$(jq '[.Results // [] | map(.Vulnerabilities // []) | add | map(select(.Severity=="LOW"))] | length' trivy_report.json)
          INFO=0

          TOTAL=$((CRIT + HIGH + MED + LOW + INFO))

          SUMMARY="CRITICAL:$CRIT,HIGH:$HIGH,MEDIUM:$MED,LOW:$LOW,INFO:$INFO,TOTAL:$TOTAL"
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "$SUMMARY" > sca_summary.txt

        shell: bash


      - name: Guardar reporte SCA
        uses: actions/upload-artifact@v4
        with:
          name: trivy_report
          path: |
            trivy_report.json
            sca_summary.txt


  # -------------------------
  # DAST - OWASP ZAP
  # -------------------------
  dast_zap:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: sca_trivy
    outputs:
      dast_summary: ${{ steps.parse.outputs.summary }}
    steps:
      - name: Ejecutar ZAP Baseline Scan
        run: |
          docker run --rm \
          -v /tmp/:/zap/wrk/:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py -t http://3.88.90.245 -r zap_report.html

      - name: Procesar reporte ZAP
        id: parse
        run: |
          CRIT=0
          HIGH=$(grep -c "High" zap_report.html || true)
          MED=$(grep -c "Medium" zap_report.html || true)
          LOW=$(grep -c "Low" zap_report.html || true)
          INFO=$(grep -c "Informational" zap_report.html || true)
          TOTAL=$((CRIT + HIGH + MED + LOW + INFO))

          SUMMARY="CRITICAL:$CRIT,HIGH:$HIGH,MEDIUM:$MED,LOW:$LOW,INFO:$INFO,TOTAL:$TOTAL"
          echo "$SUMMARY" > dast_summary.txt
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

      - name: Guardar reporte ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap_report
          path: |
            /tmp/zap_report.html
            dast_summary.txt


  # -------------------------
  # NOTIFICACIÃ“N SLACK
  # -------------------------
  slack_notify:
    name: Notificar Slack
    runs-on: ubuntu-latest
    needs: [sast_semgrep, sca_trivy, dast_zap]
    if: always()
    steps:
      - name: Construir mensaje para Slack
        run: |
          parse() {
            echo "$1" | tr ',' '\n'
          }

          echo "----- RESUMEN SAST -----"
          parse "${{ needs.sast_semgrep.outputs.sast_summary }}"
          echo "----- RESUMEN SCA -----"
          parse "${{ needs.sca_trivy.outputs.sca_summary }}"
          echo "----- RESUMEN DAST -----"
          parse "${{ needs.dast_zap.outputs.dast_summary }}"

          # Extraer nÃºmeros totales
          ALL=$(( 
            $(echo ${{ needs.sast_semgrep.outputs.sast_summary }} | grep -o 'TOTAL:[0-9]*' | cut -d: -f2) +
            $(echo ${{ needs.sca_trivy.outputs.sca_summary }} | grep -o 'TOTAL:[0-9]*' | cut -d: -f2) +
            $(echo ${{ needs.dast_zap.outputs.dast_summary }} | grep -o 'TOTAL:[0-9]*' | cut -d: -f2)
          ))

          MSG="ðŸ”” *Resumen del Pipeline DevSecOps*\n\n"

          MSG+="*SAST:* ${{ needs.sast_semgrep.outputs.sast_summary }}\n"
          MSG+="*SCA:* ${{ needs.sca_trivy.outputs.sca_summary }}\n"
          MSG+="*DAST:* ${{ needs.dast_zap.outputs.dast_summary }}\n\n"

          MSG+="*TOTAL DE VULNERABILIDADES:* $ALL\n"

          # Determinar si fallÃ³
          if [ "$ALL" -gt 0 ]; then
            MSG="âŒ *Pipeline FALLÃ“*\n$MSG"
          else
            MSG="âœ… *Pipeline COMPLETADO SIN VULNERABILIDADES*\n$MSG"
          fi

          echo "$MSG" > final_message.txt

      - name: Enviar mensaje a Slack
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"$(cat final_message.txt | sed 's/"/\\"/g')\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
