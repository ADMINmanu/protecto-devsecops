name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:

  #########################################
  #              SAST - SEMGREP
  #########################################
  sast_semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest

    outputs:

      high: ${{ steps.proc.outputs.high }}
      med:  ${{ steps.proc.outputs.med }}
      low:  ${{ steps.proc.outputs.low }}
      total: ${{ steps.proc.outputs.total }}


    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Instalar Semgrep
        run: pip install semgrep

      - name: Ejecutar SAST (Semgrep)
        run: semgrep --config "p/owasp-top-ten" . --error --json > semgrep_report.json

      - name: Guardar reporte SAST
        uses: actions/upload-artifact@v4
        with:
          name: semgrep_report
          path: semgrep_report.json

      - name: Procesar reporte SAST
        run: |
          HIGH=$(jq '[.results[] | select(.extra.severity=="ERROR")] | length' semgrep_report.json)
          MED=$(jq '[.results[] | select(.extra.severity=="WARNING")] | length' semgrep_report.json)
          LOW=$(jq '[.results[] | select(.extra.severity=="INFO")] | length' semgrep_report.json)

          TOTAL=$((HIGH + MED + LOW))

          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "med=$MED" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

  #########################################
  #              SCA - TRIVY
  #########################################
  sca_trivy:
    name: SCA - Trivy
    runs-on: ubuntu-latest
    needs: sast_semgrep


    outputs:
      crit:   ${{ steps.proc.outputs.crit }}
      high:   ${{ steps.proc.outputs.high }}
      med:    ${{ steps.proc.outputs.med }}
      low:    ${{ steps.proc.outputs.low }}
      info:   ${{ steps.proc.outputs.info }}
      total:  ${{ steps.proc.outputs.total }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Instalar Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install trivy -y

      - name: Ejecutar SCA en sistema (NO detiene pipeline)
        run: trivy fs . --severity HIGH,CRITICAL --exit-code 0 --format json -o trivy_report.json

      - name: Guardar reporte SCA
        uses: actions/upload-artifact@v4
        with:
          name: trivy_report
          path: trivy_report.json


      - name: Procesar reporte SCA
        run: |
          echo "üìä Analizando vulnerabilidades SCA..."

          # Extraer vulnerabilidades desde cualquier nivel del JSON
          CRIT=$(jq '[.. | objects | select(has("Severity")) | select(.Severity=="CRITICAL")] | length' trivy_report.json)
          HIGH=$(jq '[.. | objects | select(has("Severity")) | select(.Severity=="HIGH")] | length' trivy_report.json)
          MED=$(jq '[.. | objects | select(has("Severity")) | select(.Severity=="MEDIUM")] | length' trivy_report.json)
          LOW=$(jq '[.. | objects | select(has("Severity")) | select(.Severity=="LOW")] | length' trivy_report.json)
          INFO=$(jq '[.. | objects | select(has("Severity")) | select(.Severity=="UNKNOWN" or .Severity=="INFO")] | length' trivy_report.json)

          TOTAL=$((CRIT + HIGH + MED + LOW + INFO))

          echo "crit=$CRIT" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "med=$MED" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "info=$INFO" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT




  #########################################
  #              DAST - OWASP ZAP
  #########################################
  dast_zap:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: sca_trivy

    outputs:
      high: ${{ steps.proc.outputs.high }}
      med:  ${{ steps.proc.outputs.med }}
      low:  ${{ steps.proc.outputs.low }}
      info: ${{ steps.proc.outputs.info }}
      total: ${{ steps.proc.outputs.total }}

    steps:
      - name: Ejecutar ZAP Baseline Scan
        run: |
          docker run --rm \
            -v /tmp/:/zap/wrk/:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t https://demo.testfire.net/ -r zap_report.html

      - name: Guardar reporte ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap_report
          path: /tmp/zap_report.html

      - name: Procesar reporte DAST
        run: |
          HIGH=$(grep -ci "High" zap_report.html || true)
          MED=$(grep -ci "Medium" zap_report.html || true)
          LOW=$(grep -ci "Low" zap_report.html || true)
          INFO=$(grep -ci "Informational" zap_report.html || true)

          TOTAL=$((HIGH + MED + LOW + INFO))

          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "med=$MED" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "info=$INFO" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

  ###############################################
  # RESUMEN FINAL
  ###############################################
  resumen_final:
    name: Resumen de Vulnerabilidades
    runs-on: ubuntu-latest
    needs: [sast_semgrep, sca_trivy, dast_zap]

    steps:
      - name: Generar resumen en consola
        run: |
          echo "===== RESUMEN FINAL ====="
          echo ""
          echo "---- SAST ----"
          echo "HIGH:   ${{ needs.sast_semgrep.outputs.high }}"
          echo "MEDIUM: ${{ needs.sast_semgrep.outputs.med }}"
          echo "LOW:    ${{ needs.sast_semgrep.outputs.low }}"
          echo "TOTAL:  ${{ needs.sast_semgrep.outputs.total }}"
          echo ""
          echo "---- SCA ----"
          echo "CRITICAL: ${{ needs.sca_trivy.outputs.crit }}"
          echo "HIGH:     ${{ needs.sca_trivy.outputs.high }}"
          echo "MEDIUM:   ${{ needs.sca_trivy.outputs.med }}"
          echo "LOW:      ${{ needs.sca_trivy.outputs.low }}"
          echo "INFO:     ${{ needs.sca_trivy.outputs.info }}"
          echo "TOTAL:    ${{ needs.sca_trivy.outputs.total }}"
          echo ""
          echo "---- DAST ----"
          echo "HIGH:     ${{ needs.dast_zap.outputs.high }}"
          echo "MEDIUM:   ${{ needs.dast_zap.outputs.med }}"
          echo "LOW:      ${{ needs.dast_zap.outputs.low }}"
          echo "INFO:     ${{ needs.dast_zap.outputs.info }}"
          echo "TOTAL:    ${{ needs.dast_zap.outputs.total }}"
          echo ""
          echo "=========================="

      - name: Fallar si hay vulnerabilidades cr√≠ticas o altas
        run: |
          TOTAL_HIGH=$((
            ${{ needs.sast_semgrep.outputs.high }} +
            ${{ needs.sca_trivy.outputs.crit }} +
            ${{ needs.sca_trivy.outputs.high }} +
            ${{ needs.dast_zap.outputs.high }}
          ))

          if [ "$TOTAL_HIGH" -gt 0 ]; then
            echo "‚ùå Se detectaron vulnerabilidades CR√çTICAS o ALTAS."
            exit 1
          else
            echo "‚úî No se detectaron vulnerabilidades cr√≠ticas o altas."
          fi
